---
name: index-compare
description: A股指数比价分析工具，分析中证500、中证1000、中证A500相对沪深300的比价关系，计算历史分位、均值回归，生成智能分析报告。当用户说"比价分析"、"指数对比"、"500和1000怎么样"、"中证500分位"、"中证1000估值"、"中证A500比价"、"生成指数报告"、"查询比价"、"index compare"、"valuation analysis"时使用此技能。
---

# 指数比价分析 (Index Compare)

## 概述

此 Skill 自动化分析 A 股主要指数的比价关系，一键生成包含智能分析结论的交互式 HTML 报告。

**核心功能**：
- 📊 获取沪深300、中证500、中证1000、中证A500、上证综指的历史数据
- 📈 计算比价关系及30日移动平均线
- 📉 计算历史分位数（基于全部历史数据）
- 🤖 AI 智能分析：趋势判断、均值回归、配置建议
- 🎨 生成 Plotly 交互式 HTML 报告
- 🧹 自动清理临时文件，保持目录整洁

**最新优化**：
- ✅ 图表分位数标注优化：显示在图表下方中央，不遮挡内容
- ✅ 红绿虚线精准匹配：标注显示范围内的最高点和最低点
- ✅ 图表高度优化：增加底部空间，完整显示所有标注
- ✅ 自动清理功能：临时文件超过20个时自动清理

## 🚀 快速开始

### 方式1：完整分析（推荐首次使用）

**一键运行完整分析流程：**
```bash
python scripts/main.py
```

**这个命令会自动完成所有步骤：**
1. ✓ 自动清理临时文件（超过20个时触发）
2. ✓ 检查环境配置（TUSHARE_TOKEN）
3. ✓ 获取最新指数数据
4. ✓ 计算比价和历史分位
5. ✓ 生成智能分析结论
6. ✓ 输出 HTML 交互式报告

**你将得到：**
- 📊 控制台显示数据摘要表格
- 💡 配置建议（超配/标配/低配）
- 📄 HTML 报告文件：`../../index_compare_YYYYMMDD_HHMMSS.html`

**执行时间：** 约 30-60 秒（取决于网络速度）

### 方式2：快速查询（查看已有数据）

**查询所有指数：**
```bash
python scripts/main.py --query
```

**查询特定指数：**
```bash
python scripts/main.py --query ZZ500     # 只看中证500
python scripts/main.py --query ZZ1000    # 只看中证1000
python scripts/main.py --query ZZA500    # 只看中证A500
```

**特点：**
- ⚡ 无需重新获取数据，瞬间返回结果（< 1秒）
- 📋 显示上次分析的结果和数据更新时间
- 🎯 适合快速查看当前配置建议

---

---

## ⚙️ 环境要求

### 必须设置 API Token

**环境变量设置：**
```bash
# Windows PowerShell
$env:TUSHARE_TOKEN = "你的Token"

# Windows CMD
set TUSHARE_TOKEN=你的Token

# Linux/Mac
export TUSHARE_TOKEN=你的Token
```

**或者创建 .env 文件：**
```bash
# 在 skill 目录下创建 .env 文件
TUSHARE_TOKEN=你的Token
```

📝 获取 Token：https://tushare.pro/register

### Python 依赖包

```
tushare>=1.2.0
pandas>=1.5.0
numpy>=1.20.0
plotly>=5.0.0
scipy>=1.7.0
```

**安装命令：**
```bash
pip install tushare pandas numpy plotly scipy
```

---

---

## 📈 分析指标说明

### 历史分位数（基于全部历史数据）

| 分位区间 | 解读 | 建议 |
|----------|------|------|
| < 20% | 🔥 极度低估 | 强烈超配信号 |
| 20-40% | 📉 相对低估 | 可考虑超配 |
| 40-60% | ⚖️ 中性区域 | 标配 |
| 60-80% | 📈 相对高估 | 可考虑低配 |
| > 80% | 🚨 极度高估 | 强烈低配信号 |

### 均值回归（偏离30日均线）

| 偏离度 | 状态 | 解读 |
|--------|------|------|
| > +5% | 超买 | 短期超买，可能回调 |
| < -5% | 超卖 | 短期超卖，可能反弹 |
| ±5%内 | 正常 | 正常波动范围 |

### 趋势判断

- 📊 比较当前比价与 5日/10日/20日 前的数据
- 📉 判断上升、下降或震荡趋势
- 🎯 结合历史分位和偏离度综合分析

### 配置建议逻辑

综合 **趋势**、**分位**、**偏离度** 三个维度，AI 智能生成：
- 📈 **超配建议**：分位低 + 趋势向上 + 超卖
- ⚖️ **标配建议**：分位中性 + 趋势不明
- 📉 **低配建议**：分位高 + 趋势向下 + 超买

---

## 📊 输出示例

### 完整分析模式输出

运行 `python scripts/main.py` 后，控制台会显示：

```
============================================================
         指数比价分析 (Index Compare)
============================================================
执行时间: 2026-01-25 14:30:52
============================================================

[步骤 1/5] 检查环境配置...
[OK] Token 已配置

[步骤 2/5] 获取指数数据...
[OK] 数据获取完成

[步骤 3/5] 计算比价指标...
[OK] 比价计算完成

[步骤 4/5] 生成智能分析...
[OK] 分析完成

[步骤 5/5] 生成 HTML 报告...
[OK] 报告生成完成

============================================================
         [OK] 分析完成!
============================================================

[DATA] 最新数据 (2026-01-25):
+-------------+----------+----------+----------+
| 指标        | 中证500  | 中证1000 | 沪深300  |
+-------------+----------+----------+----------+
| 收盘价      |  5234.56 |  4567.89 |  3456.78 |
| 比价        |   1.5142 |   1.3214 | (基准)   |
| 历史分位    |    35.2% |    68.5% |    -     |
| 30日偏离    |    -3.5% |    +2.8% |    -     |
+-------------+----------+----------+----------+

[RECOMMEND] 配置建议:

【中证500】📈 超配
  - 历史分位35%，相对低估
  - 短期超卖，可能反弹
  - 趋势向上

【中证1000】⚖️ 标配
  - 历史分位68%，相对高估
  - 短期超买，注意回调风险
  - 趋势震荡

[REPORT] 报告文件: ../../index_compare_20260125_143052.html

提示: 用浏览器打开上述 HTML 文件查看交互式报告
```

### 快速查询模式输出

运行 `python scripts/main.py --query` 后，控制台会显示：

```
============================================================
         指数比价快速查询
============================================================
数据更新时间: 2026-01-25

最新数据:
┌─────────────┬──────────┬──────────┬──────────┐
│ 指标        │ 中证500  │ 中证1000 │ 中证A500 │
├─────────────┼──────────┼──────────┼──────────┤
│ 当前比价    │   1.5142 │   1.3214 │   0.9876 │
│ 历史分位    │    35.2% │    68.5% │    42.1% │
│ 30日偏离    │    -3.5% │    +2.8% │    -1.2% │
│ 配置建议    │  📈 超配  │  ⚖️ 标配  │  ⚖️ 标配  │
└─────────────┴──────────┴──────────┴──────────┘

【中证500】📈 超配
历史分位35%，相对低估。短期超卖，可能反弹。趋势向上。

【中证1000】⚖️ 标配
历史分位68%，相对高估。短期超买，注意回调风险。

【中证A500】⚖️ 标配
历史分位42%，中性区域。短期正常波动。
```

---

---

## ⚠️ 错误处理

| 错误场景 | 处理方式 | 用户操作 |
|---------|---------|---------|
| Token 未设置 | 打印详细设置指南，终止执行 | 按提示设置环境变量 |
| API 调用失败 | 自动重试3次，间隔2秒 | 检查网络连接和 Token 有效性 |
| 数据获取不完整 | 使用可用数据继续分析 | 查看报告中的数据说明 |
| 报告目录不存在 | 自动创建目录 | 无需操作 |
| 依赖包缺失 | 打印安装命令 | 运行 pip install 命令 |

---

## 📚 技术细节

如需了解更多技术实现细节，可以查看：

- **`config.json`** - 指数配置和分析参数
- **`analysis-rules.md`** - 详细的分析规则说明
- **`scripts/`** - 各个 Python 模块的实现

**模块说明：**
- `fetch_data.py` - 数据获取模块
- `calculate.py` - 比价计算模块
- `analyze.py` - 智能分析模块
- `generate_report.py` - 报告生成模块
- `cleanup.py` - 临时文件清理模块
- `main.py` - 主入口（推荐直接使用）

---

## 🧹 临时文件管理

### 自动清理

主程序启动时会自动检查并清理临时文件：
- **触发条件**：`tmpclaude-*` 文件数量 ≥ 20 个
- **清理范围**：整个项目目录（包括所有子目录）
- **执行时机**：每次运行 `python scripts/main.py` 时自动执行

### 手动清理

如需手动清理临时文件：

```bash
# 强制清理所有临时文件
python scripts/cleanup.py --force

# 自定义阈值（例如10个文件时清理）
python scripts/cleanup.py --max 10

# 查看帮助
python scripts/cleanup.py --help
```

### .gitignore 配置

项目已配置 `.gitignore` 文件，自动忽略：
- `tmpclaude-*` 临时文件
- Python 缓存文件（`__pycache__/`, `*.pyc`）
- 环境变量文件（`.env`）
- 其他系统临时文件

---

## 📊 HTML 报告特性

### 图表优化

**比价走势对比图表**：
- 📍 **分位数标注**：显示在图表下方中央，格式为"当前分位数：xx%"
- 📈 **区间最高/最低线**：红色虚线标注显示范围内最高点，绿色虚线标注最低点
- 📏 **图表尺寸**：高度 380px，底部留出 80px 空间确保标注完整显示
- 🎨 **交互功能**：支持缩放、平移、悬停查看详细数据

**价格走势图表**：
- 📊 显示近1000个交易日的指数价格走势
- 🎨 深色主题，金融终端风格
- 🔍 支持图例切换，可单独查看某个指数

### 报告内容

- **指标卡片**：实时显示各指数的比价、分位、偏离度
- **价格走势**：多指数价格对比图
- **比价走势**：三个比价图表并排显示
- **智能分析**：详细的分析结论和配置建议

---

**💡 提示：** 直接运行 `python scripts/main.py` 即可完成所有分析，无需手动执行各个模块。

## 📝 版本历史

### v0.2.0 (2026-02-12)
- ✨ 新增自动清理临时文件功能
- 🎨 优化图表分位数标注位置（下方中央）
- 🔧 修复红绿虚线位置，精准匹配显示范围
- 📏 增加图表高度和底部边距
- 🔧 修复 Plotly 图表加载问题
- 📝 添加 .gitignore 配置

### v0.1.0 (2026-01-30)
- 🎉 初始版本发布
- 📊 实现完整的指数比价分析流程
- 🤖 集成 AI 智能分析
- 🎨 生成交互式 HTML 报告

