# 分析规则详细说明

## 1. 比价计算

### 1.1 原始比价
```
比价 = 目标指数收盘价 / 基准指数收盘价

ZZ500_ratio = ZZ500.close / HS300.close
ZZ1000_ratio = ZZ1000.close / HS300.close
```

### 1.2 移动平均
```
MA30 = ratio.rolling(window=30).mean()
```

### 1.3 偏离度
```
deviation = (current_ratio - MA30) / MA30 * 100%
```

---

## 2. 历史分位计算

使用 scipy.stats.percentileofscore 计算当前比价在全部历史数据中的分位。

```python
from scipy.stats import percentileofscore

percentile = percentileofscore(all_history_ratios, current_ratio)
```

**注意**：使用全部历史数据（从2015年至今），而非仅近期数据。

---

## 3. 趋势判断规则

### 3.1 计算方法
比较当前比价与 N 日前的比价变化：

```python
change_5d = (current - ratio_5d_ago) / ratio_5d_ago * 100
change_10d = (current - ratio_10d_ago) / ratio_10d_ago * 100
change_20d = (current - ratio_20d_ago) / ratio_20d_ago * 100
```

### 3.2 判定标准

| 条件 | 趋势判定 |
|------|----------|
| 5日、10日、20日变化均 > 1% | 强上升趋势 |
| 多数变化 > 0.5% | 弱上升趋势 |
| 变化在 ±0.5% 内 | 震荡 |
| 多数变化 < -0.5% | 弱下降趋势 |
| 5日、10日、20日变化均 < -1% | 强下降趋势 |

---

## 4. 分位解读规则

| 分位区间 | 状态 | 解读 | 建议方向 |
|----------|------|------|----------|
| 0-20% | 极度低估 | 当前比价处于历史最低区域，中小盘相对大盘极具性价比 | 强烈超配 |
| 20-40% | 相对低估 | 当前比价低于历史中位数，中小盘有相对优势 | 可超配 |
| 40-60% | 中性 | 当前比价处于历史中位水平，大小盘估值相对均衡 | 标配 |
| 60-80% | 相对高估 | 当前比价高于历史中位数，中小盘相对大盘偏贵 | 可低配 |
| 80-100% | 极度高估 | 当前比价处于历史最高区域，中小盘相对大盘极为昂贵 | 强烈低配 |

---

## 5. 均值回归规则

| 偏离度 | 状态 | 解读 |
|--------|------|------|
| > +10% | 严重超买 | 大幅偏离均线上方，短期回调风险高 |
| +5% ~ +10% | 超买 | 偏离均线上方，需警惕回调 |
| -5% ~ +5% | 正常 | 在均线附近波动，属于正常状态 |
| -10% ~ -5% | 超卖 | 偏离均线下方，可能迎来反弹 |
| < -10% | 严重超卖 | 大幅偏离均线下方，反弹概率高 |

---

## 6. 综合配置建议生成

### 6.1 评分体系

为每个维度打分（-2 到 +2）：

**分位得分**：
| 分位 | 得分 |
|------|------|
| 0-15% | +2 |
| 15-30% | +1 |
| 30-70% | 0 |
| 70-85% | -1 |
| 85-100% | -2 |

**趋势得分**（原始）：
| 趋势 | 得分 |
|------|------|
| 强上升 | +2 |
| 弱上升 | +1 |
| 震荡 | 0 |
| 弱下降 | -1 |
| 强下降 | -2 |

**偏离度得分**：
| 偏离 | 得分 |
|------|------|
| < -10% | +2 |
| -10% ~ -5% | +1 |
| -5% ~ +5% | 0 |
| +5% ~ +10% | -1 |
| > +10% | -2 |

### 6.2 趋势方向调整（重要）

趋势得分需要根据当前分位情况进行方向调整：

| 分位区域 | 趋势得分处理 | 逻辑说明 |
|----------|--------------|----------|
| **高估区域 (>60%)** | **取反** | 高估时趋势上升 = 追高风险（负面）；趋势下降 = 回归均值（正面） |
| **低估区域 (<40%)** | 保持原样 | 低估时趋势上升 = 开始反弹（正面）；趋势下降 = 继续下跌（负面） |
| **中性区域 (40-60%)** | 保持原样 | 趋势正常计算 |

**示例**：
- 分位 73%（高估）+ 强上升趋势：原得分 +2 → 调整后 **-2**
- 分位 25%（低估）+ 强上升趋势：原得分 +2 → 保持 **+2**
- 分位 50%（中性）+ 强上升趋势：原得分 +2 → 保持 **+2**

### 6.3 综合建议计算

```
总分 = 分位得分 × 0.60 + 调整后趋势得分 × 0.25 + 偏离度得分 × 0.15
```

**权重说明**：
- 分位权重 60%：历史估值水平是最重要的参考指标
- 趋势权重 25%：短期趋势作为辅助判断
- 偏离度权重 15%：均值回归作为补充参考

| 总分区间 | 建议 | 图标 |
|----------|------|------|
| > 1.0 | 强烈超配 | [++] |
| 0.5 ~ 1.0 | 超配 | [+] |
| -0.5 ~ 0.5 | 标配 | [=] |
| -1.0 ~ -0.5 | 低配 | [-] |
| < -1.0 | 强烈低配 | [--] |

### 6.4 计算示例

**示例1：中证500（高估 + 强上升）**
- 分位 73.2%（高估）→ 得分 -1
- 趋势：强上升 → 原得分 +2，因高估取反 → **-2**
- 偏离度 +3.21%（正常）→ 得分 0
- 总分 = -1 × 0.6 + (-2) × 0.25 + 0 × 0.15 = **-1.1** → 强烈低配

**示例2：中证1000（中性 + 强上升）**
- 分位 57.3%（中性）→ 得分 0
- 趋势：强上升 → 得分 +2，中性区域保持 → **+2**
- 偏离度 +1.88%（正常）→ 得分 0
- 总分 = 0 × 0.6 + 2 × 0.25 + 0 × 0.15 = **0.5** → 标配

**示例3：假设低估 + 强上升**
- 分位 25%（低估）→ 得分 +1
- 趋势：强上升 → 得分 +2，低估区域保持 → **+2**
- 偏离度（正常）→ 得分 0
- 总分 = 1 × 0.6 + 2 × 0.25 + 0 × 0.15 = **1.1** → 强烈超配

---

## 7. 报告文案模板

### 7.1 趋势描述模板

```
【{指数名称}】近期呈现{趋势判定}趋势。
- 5日变化: {change_5d}%
- 10日变化: {change_10d}%
- 20日变化: {change_20d}%
{趋势解读}
```

### 7.2 分位描述模板

```
当前{指数名称}相对沪深300的比价为{ratio}，处于历史{percentile}%分位，
属于{分位状态}区域。{分位解读}
```

### 7.3 均值回归描述模板

```
当前比价{高于/低于}30日均线{abs(deviation)}%，{偏离状态}。{均值回归解读}
```

### 7.4 综合建议模板

```
综合考虑历史分位({percentile}%)、趋势({trend})和均值偏离({deviation}%)，
建议对{指数名称}采取【{建议}】策略。

理由:
1. {分位理由}
2. {趋势理由}（注：高估区域趋势方向已调整）
3. {偏离理由}
```
