# PRD: index-compare Skill 产品需求文档

> **版本**: v1.0
> **创建日期**: 2026-01-03
> **状态**: 待确认

---

## 1. 概述

### 1.1 产品定位
`index-compare` 是一个 Claude Code Skill，用于自动化分析 A 股主要指数（中证500、中证1000）相对于沪深300的比价关系，并生成包含智能分析结论的交互式 HTML 报告。

### 1.2 核心价值
- **自动化**：一键获取数据、计算比价、生成报告
- **智能分析**：AI 解读比价趋势，给出配置建议
- **可视化**：交互式图表，支持缩放、悬停查看详情

---

## 2. 需求汇总

| 维度 | 决策 |
|------|------|
| **使用场景** | 定期报告生成 + 即时查询分析 |
| **输入方式** | 固定指数组合（预设配置） |
| **输出格式** | HTML 交互式报告（Plotly） |
| **智能分析** | 趋势判断 + 历史分位 + 均值回归 + 配置建议 |
| **比较基准** | 沪深300 (000300.SH) |
| **历史范围** | 近 250 个交易日 |
| **Token 管理** | 环境变量 `TUSHARE_TOKEN` |
| **Skill 名称** | `index-compare` |
| **输出位置** | `reports/` 目录 |

---

## 3. 功能规格

### 3.1 数据获取模块

**输入**：
- 指数代码列表（预设）
- 时间范围（默认：近250交易日）

**预设指数组合**：
```python
INDICES = {
    'HS300': ('000300.SH', '沪深300'),    # 基准
    'ZZ500': ('000905.SH', '中证500'),    # 中盘股
    'ZZ1000': ('000852.SH', '中证1000'),  # 小盘股
    'SHCI': ('000001.SH', '上证综指'),    # 参考
}
```

**输出**：
- `raw_data.csv`：原始收盘价数据

**错误处理**：
- API 调用失败：重试 3 次，间隔 2 秒
- 数据缺失：使用前向填充 (ffill)

---

### 3.2 比价计算模块

**计算指标**：

| 指标 | 公式 | 说明 |
|------|------|------|
| 原始比价 | ZZ500 / HS300 | 中证500相对沪深300 |
| 原始比价 | ZZ1000 / HS300 | 中证1000相对沪深300 |
| 30日均线 | rolling(30).mean() | 平滑趋势 |
| 历史分位 | percentileofscore() | 当前比价在历史中的位置 |
| 偏离度 | (当前 - 均线) / 均线 × 100% | 偏离均线程度 |

**输出**：
- `processed_data.csv`：包含所有计算指标

---

### 3.3 智能分析模块

**分析维度**：

#### 3.3.1 趋势判断
- 比较当前比价与 5日/10日/20日 前的比价
- 判定：上升趋势 / 下降趋势 / 震荡

#### 3.3.2 历史分位判断
- 计算当前比价在过去 250 日的分位数
- 分位 < 20%：极度低估区域
- 分位 20-40%：相对低估
- 分位 40-60%：中性区域
- 分位 60-80%：相对高估
- 分位 > 80%：极度高估区域

#### 3.3.3 均值回归分析
- 计算当前比价偏离 30 日均线的幅度
- 偏离 > +5%：短期超买，可能回调
- 偏离 < -5%：短期超卖，可能反弹
- 偏离 ±5% 以内：正常波动

#### 3.3.4 配置建议
基于以上三个维度，由 LLM 综合分析生成：
- **超配建议**：分位低 + 趋势向上 + 超卖
- **标配建议**：分位中性 + 趋势不明
- **低配建议**：分位高 + 趋势向下 + 超买

---

### 3.4 报告生成模块

**HTML 报告结构**：

```
┌─────────────────────────────────────────────┐
│              指数比价分析报告                │
│           生成时间: 2026-01-03              │
├─────────────────────────────────────────────┤
│  📊 数据概览                                │
│  ├─ 最新交易日: xxxx-xx-xx                  │
│  ├─ 数据范围: 250 个交易日                   │
│  └─ 基准指数: 沪深300                        │
├─────────────────────────────────────────────┤
│  📈 交互式图表 (Plotly)                      │
│  ├─ 图1: 中证500/沪深300 比价走势            │
│  │      (含30日均线、历史分位带)             │
│  ├─ 图2: 中证1000/沪深300 比价走势           │
│  │      (含30日均线、历史分位带)             │
│  └─ 图3: 上证综指参考走势                    │
├─────────────────────────────────────────────┤
│  📋 关键指标卡片                             │
│  ┌─────────┬─────────┬─────────┐            │
│  │ ZZ500   │ ZZ1000  │ 基准    │            │
│  │ 比价:xx │ 比价:xx │ 点位:xx │            │
│  │ 分位:xx%│ 分位:xx%│         │            │
│  │ 偏离:xx%│ 偏离:xx%│         │            │
│  └─────────┴─────────┴─────────┘            │
├─────────────────────────────────────────────┤
│  🤖 AI 分析结论                              │
│  ├─ 趋势判断: ...                           │
│  ├─ 分位解读: ...                           │
│  ├─ 均值回归: ...                           │
│  └─ 配置建议: ...                           │
└─────────────────────────────────────────────┘
```

**输出文件**：
- `reports/index_compare_YYYYMMDD_HHMMSS.html`

---

## 4. 技术架构

### 4.1 目录结构

```
.claude/skills/index-compare/
├── SKILL.md                 # Skill 主文件
├── config.json              # 指数配置
├── analysis-rules.md        # 分析规则说明
└── scripts/
    ├── fetch_data.py        # 数据获取
    ├── calculate.py         # 比价计算
    ├── analyze.py           # 智能分析
    └── generate_report.py   # 报告生成
```

### 4.2 依赖项

```
tushare>=1.2.0
pandas>=1.5.0
numpy>=1.20.0
plotly>=5.0.0
```

### 4.3 环境变量

| 变量名 | 说明 | 必需 |
|--------|------|------|
| `TUSHARE_TOKEN` | Tushare API Token | 是 |

---

## 5. 用户交互流程

### 5.1 定期报告模式
```
用户: /index-compare

Claude:
1. [获取数据] 正在从 Tushare 获取最新行情...
2. [计算比价] 正在计算中证500、中证1000相对沪深300的比价...
3. [智能分析] 正在分析趋势和分位...
4. [生成报告] 正在生成 HTML 报告...

✅ 报告已生成: reports/index_compare_20260103_143052.html

📊 快速摘要：
- 中证500/沪深300: 1.2345 (历史分位 35%, 相对低估)
- 中证1000/沪深300: 0.8765 (历史分位 72%, 相对高估)

建议: 当前中证500相对沪深300处于历史较低位置，可考虑适度超配中证500...
```

### 5.2 即时查询模式
```
用户: /index-compare 查询中证1000

Claude:
📈 中证1000 最新比价分析：
- 当前比价: 0.8765 (vs 沪深300)
- 历史分位: 72% (近1年)
- 30日均线偏离: +3.2%
- 趋势: 短期上升

💡 解读: 中证1000当前比价处于历史较高分位，短期有超买迹象...
```

---

## 6. 错误处理策略

| 场景 | 处理方式 |
|------|----------|
| TUSHARE_TOKEN 未设置 | 提示用户设置环境变量并给出示例 |
| API 调用失败 | 重试3次，仍失败则报错并建议检查网络/Token |
| 数据不足250天 | 使用可用数据并在报告中注明 |
| 报告目录不存在 | 自动创建 `reports/` 目录 |

---

## 7. 待确认事项

请确认以下内容是否符合您的预期：

1. **指数组合**：当前仅包含 沪深300、中证500、中证1000、上证综指，是否需要增加其他指数？

2. **行业ETF**：您的 notebook 中还有行业ETF比价分析，是否需要在这个 Skill 中一并支持？

3. **历史分位计算**：基于近 250 日数据计算分位，还是全部历史数据？

4. **报告语言**：报告内容使用中文还是中英双语？

5. **自动打开**：生成报告后是否自动在浏览器中打开？

---

## 8. 下一步

确认 PRD 无误后，我将：
1. 创建 `.claude/skills/index-compare/` 目录结构
2. 编写 `SKILL.md` 主文件
3. 实现各个 Python 脚本
4. 测试完整流程

---

*文档结束*
